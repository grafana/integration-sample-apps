# /jinja/templates/grafana-agent-k8s-template.yaml.j2
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-agent-config
data:
  grafana-agent.yaml: |
    integrations:
      node_exporter:
        enabled: true
        relabel_configs:
        - replacement: hostname
          target_label: instance
      prometheus_remote_write:
      - url: "{{ prom_url }}"
        {% if prom_user and prom_pass -%}
        basic_auth:
          password: "{{ prom_pass }}"
          username: "{{ prom_user }}"
        {%- endif %}

    metrics:
      configs:
      - name: integrations/openldap
        remote_write:
        - url: "{{ prom_url }}"
          {% if prom_user and prom_pass -%}
          basic_auth:
            password: "{{ prom_pass }}"
            username: "{{ prom_user }}"
          {%- endif %}
        scrape_configs:
        - job_name: integrations/openldap
          metrics_path: /metrics
          static_configs:
          - targets: ["openldap-exporter:9330"]
            labels:
              cluster: "openldap_cluster"
          kubernetes_sd_configs:
          - role: pod
          relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: "{{ openldap_app_label }}"
          - target_label: job
            replacement: "integrations/openldap"
          - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_pod_name]
            separator: "-"
            target_label: instance
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - source_labels: [__meta_kubernetes_pod_label_cluster]
            target_label: cluster

      global:
        scrape_interval: 60s
      wal_directory: /tmp/grafana-agent-wal

