# /jinja/templates/grafana-flow-k8s-template.yaml.j2
cluster:
  name: "openldap_cluster"

externalServices:
  prometheus:
    host: "https://prometheus-us-central1.grafana.net"
    basicAuth:
      username: "{{ prom_user }}"
      password: "{{ prom_pass }}"
  loki:
    host: "https://logs-prod3.grafana.net"
    basicAuth:
      username: "{{ loki_user }}"
      password: "{{ loki_pass }}"

logs:
  enabled: true
  extraConfig: |-
    discovery.relabel "openldap_logs" {
      targets = discovery.kubernetes.pods.targets

      rule {
        action        = "keep"
        source_labels = ["__meta_kubernetes_pod_label_app"]
        regex         = "{{ openldap_app_label }}"
      }
      rule {
        target_label = "job"
        replacement = "integrations/openldap"
      }
      rule {
        source_labels = ["__meta_kubernetes_namespace", "__meta_kubernetes_pod_name"]
        separator = "-"
        target_label = "instance"
      }
      rule {
        action = "replace"
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label  = "pod"
      }
    }

    loki.source.kubernetes "openldap_logs" {
      targets    = discovery.relabel.openldap_logs.output
      forward_to = [loki.write.grafana_cloud_loki.receiver]
    }
