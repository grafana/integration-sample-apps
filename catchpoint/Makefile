VM_NAME := catchpoint
K8S_NAMESPACE := default
CONFIG_FILE := jinja/variables/cloud-init.yaml
TEMPLATE_DIR := jinja/templates
OUTPUT_DIR := generated_configs
GRAFANA_FLOW_VALUES := $(OUTPUT_DIR)/grafana-flow-k8s-template.yaml

.PHONY: run-catchpoint-multipass
run-catchpoint-multipass: render-config
	@multipass launch -n $(VM_NAME) --memory 14G --disk 10G --cpus 4
	@multipass mount ./generated_configs/ $(VM_NAME):/catchpoint/config
	@multipass mount ./scripts $(VM_NAME):/catchpoint/scripts
	@multipass exec $(VM_NAME) -- bash /catchpoint/scripts/setup_docker.sh
	@multipass stop $(VM_NAME)
	@multipass start $(VM_NAME)
	@multipass exec $(VM_NAME) -- bash /catchpoint/scripts/init_script.sh

.PHONY: stop-catchpoint-multipass
stop-catchpoint-multipass:
	@multipass stop $(VM_NAME)
	@multipass delete $(VM_NAME)
	@sleep 10
	@multipass purge

.PHONY: port-forward
port-forward:
	@echo "Setting kubectl context to minikube"
	@multipass exec $(VM_NAME) -- bash -c "kubectl config use-context minikube"
	@echo "Starting port-forwarding for Prometheus exporter"
	@multipass exec $(VM_NAME) -- bash -c "kubectl --context=minikube -n $(K8S_NAMESPACE) port-forward svc/catchpoint-exporter 9090:9090 &"
	@sleep 5 # Wait a few seconds to ensure port-forwarding is established
	@echo "Port-forwarding enabled for Prometheus exporter."

.PHONY: run-metrics
run-metrics:
	@echo "Running post_metrics.py script"
	@multipass exec $(VM_NAME) -- python3 /catchpoint/scripts/post_metrics.py
	@echo "Metrics script executed."

.PHONY: render-config
render-config:
	python3 scripts/render_template.py --config_file $(CONFIG_FILE) --template_dir $(TEMPLATE_DIR) --output_dir $(OUTPUT_DIR)
	@echo "Config templates rendered."

.PHONY: clean
clean:
	@echo "Cleaning generated configs..."
	@rm -f cloud-init.yaml
	@rm -rf $(OUTPUT_DIR)/*
	@echo "Generated configs cleaned."

.PHONY: defaultconfig
defaultconfig:
	@echo "exporter_repo: https://github.com/grafana/catchpoint-prometheus-exporter.git" > jinja/variables/cloud-init.yaml
	@echo "exporter_dir: catchpoint-prometheus-exporter" >> jinja/variables/cloud-init.yaml
	@echo "prom_addr: \":9090\"" >> jinja/variables/cloud-init.yaml
	@echo "loki_url: http://your-loki-instance:3100/loki/api/v1/push" >> jinja/variables/cloud-init.yaml
	@echo "loki_user: your_loki_username" >> jinja/variables/cloud-init.yaml
	@echo "loki_pass: your_loki_password" >> jinja/variables/cloud-init.yaml
	@echo "prom_url: http://your-prometheus-instance:9090/api/v1/push" >> jinja/variables/cloud-init.yaml
	@echo "prom_user: your_prometheus_username" >> jinja/variables/cloud-init.yaml
	@echo "prom_pass: your_prometheus_password" >> jinja/variables/cloud-init.yaml
	@echo "prom_port: 9090" >> jinja/variables/cloud-init.yaml

.PHONY: fetch-prometheus-metrics
fetch-prometheus-metrics:
	@multipass exec $(VM_NAME) -- curl http://localhost:9090/metrics > prometheus_metrics

.PHONY: all
all: run-catchpoint-multipass port-forward run-metrics
	@echo "All tasks completed."
